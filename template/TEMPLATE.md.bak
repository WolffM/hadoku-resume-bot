# Child App Template Guide

Complete template for building a child app that integrates with the hadoku parent ecosystem.

---

## Quick Start

1. Copy this template folder to your new repo
2. Replace `@wolffm/your-app` with your package name
3. Install dependencies: `pnpm install`
4. Set up git hooks: `pnpm exec husky init && chmod +x .husky/pre-commit`
5. Add `HADOKU_SITE_TOKEN` secret to GitHub repo
6. Push to main to deploy

---

## Template Structure

```
template/
├── .github/workflows/publish.yml  # Auto-deploy on push to main
├── .husky/pre-commit              # Auto-fix lint/format, version bump
├── src/
│   ├── entry.tsx                  # Mount/unmount exports (REQUIRED)
│   ├── App.tsx                    # Main component
│   └── styles/index.css           # Theme-aware CSS
├── .gitignore                     # Files to ignore in git
├── .npmrc                         # pnpm + GitHub Packages config
├── .prettierrc                    # Code formatting rules
├── eslint.config.js               # Linting rules
├── package.json                   # Dependencies & scripts
├── tsconfig.json                  # TypeScript dev config
├── tsconfig.build.json            # TypeScript build config
├── vite.config.ts                 # Vite bundler config
├── README.md                      # Project documentation
└── TEMPLATE.md                    # This guide
```

**Copy entire folder** to your new repo, then customize.

---

## Required Files

### 1. `src/entry.tsx` - Mount/Unmount Pattern

**REQUIRED**: Parent expects these exports.

```typescript
import { createRoot } from 'react-dom/client';
import App from './App';

export interface YourAppProps {
  theme?: string;              // 'default', 'ocean', 'forest', etc.
  environment?: 'development' | 'production';
  userType?: 'admin' | 'friend' | 'public';
  serverOrigin?: string;       // API endpoint
  sessionId?: string;          // Session identifier
}

export function mount(el: HTMLElement, props: YourAppProps = {}) {
  const root = createRoot(el);
  root.render(<App {...props} />);
  (el as any).__root = root;
}

export function unmount(el: HTMLElement) {
  ((el as any).__root)?.unmount();
}
```

**Parent calls your mount function**:
```typescript
import { mount } from '@wolffm/your-app';
mount(document.getElementById('app-root'), { theme: 'ocean' });
```

### 2. `package.json` - Dependencies

```json
{
  "name": "@wolffm/your-app",
  "version": "1.0.0",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "files": ["dist"],
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --fix",
    "format": "prettier --write .",
    "prepare": "husky"
  },
  "peerDependencies": {
    "@wolffm/themes": ">=1.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "@vitejs/plugin-react": "^4.3.4",
    "eslint": "^9.17.0",
    "husky": "^9.1.7",
    "prettier": "^3.4.2",
    "typescript": "^5.7.2",
    "vite": "^6.0.3"
  },
  "publishConfig": {
    "registry": "https://npm.pkg.github.com"
  }
}
```

**Key points**:
- `@wolffm/themes` in `peerDependencies` (parent provides)
- `publishConfig` points to GitHub Packages
- `prepare` script runs `husky` to set up git hooks

### 3. `vite.config.ts` - Build Config

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    lib: {
      entry: 'src/entry.tsx',
      name: 'YourApp',
      formats: ['es'],
      fileName: () => 'index.js'
    },
    rollupOptions: {
      external: ['react', 'react-dom', '@wolffm/themes'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM'
        },
        assetFileNames: 'style.css'
      }
    }
  }
});
```

**Important**: Mark `react`, `react-dom`, and `@wolffm/themes` as `external` (parent provides them).

---

## Dependencies & Tooling

### Peer Dependencies (Provided by Parent)

```json
"peerDependencies": {
  "@wolffm/themes": ">=1.0.0",
  "react": "^19.0.0",
  "react-dom": "^19.0.0"
}
```

**Why peer dependencies?**
- Single React instance (required for hooks to work)
- Smaller bundle size (parent provides these)
- Version compatibility guaranteed

### Dev Dependencies (Your Repo Only)

```json
"devDependencies": {
  "vite": "^6.0.3",
  "typescript": "^5.7.2",
  "eslint": "^9.17.0",
  "prettier": "^3.4.2",
  "husky": "^9.1.7"
}
```

### Additional Dependencies (Your Choice)

Add whatever you need for your app:
```bash
pnpm add axios zustand react-router-dom
```

### Why pnpm?

- Consistent workspace management
- Enforces GitHub Packages registry via `.npmrc`
- Faster than npm/yarn

`.npmrc` config:
```
@wolffm:registry=https://npm.pkg.github.com
//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}
```

---

## Setup Instructions

### 1. Install Dependencies

```bash
pnpm install
```

### 2. Set Up Git Hooks (Husky)

```bash
pnpm exec husky init
chmod +x .husky/pre-commit
```

**What the pre-commit hook does**:
- Runs Prettier formatting
- Runs ESLint auto-fixes
- Auto-bumps version number
- Stages changes

### 3. Add GitHub Secret

**In your repo**: Settings → Secrets and variables → Actions

Add secret:
- **Name**: `HADOKU_SITE_TOKEN`
- **Value**: Get from hadoku_site admin (PAT with `repo` + `workflow` scopes)

**Why needed?** Triggers parent deployment when you publish a new version.

### 4. Customize Placeholders

Replace in all files:
- `@wolffm/your-app` → `@wolffm/resume-bot`
- `your-app` → `resume-bot`
- `YourApp` → `ResumeBot`

Files to update:
- `package.json` - name, description, repository
- `vite.config.ts` - library name
- `src/entry.tsx` - interface names
- `src/styles/index.css` - CSS class names

---

## Development Workflow

### Local Development

```bash
pnpm dev          # Start dev server (http://localhost:5173)
pnpm build        # Production build
pnpm preview      # Preview production build
```

### Code Quality

```bash
pnpm lint         # Check for issues
pnpm lint:fix     # Auto-fix issues
pnpm format       # Format all files
```

### Git Workflow

```bash
git add .
git commit -m "feat: add chat interface"  # Pre-commit hook auto-bumps version
git push origin main                       # Triggers auto-deploy
```

**Versioning (automatic)**:
- Only bumps when `src/` or `package.json` changes
- Patch increment: `1.0.0` → `1.0.1` → `1.0.2` → ...
- Rollover at `.20`: `1.0.20` → `1.1.0`
- Doc-only commits don't trigger version bumps
- Skip hook: `git commit --no-verify` (use sparingly)

---

## Theme Integration (MANDATORY)

**All apps MUST use `@wolffm/themes`** - this is not optional.

### Step 1: Import CSS

In `src/entry.tsx`:
```typescript
import '@wolffm/themes/themes.css'; // REQUIRED
import './styles/index.css';        // Your styles
```

### Step 2: Apply Theme Attributes

In `src/App.tsx`:
```typescript
import { useEffect, useRef, useState } from 'react';

export default function App({ theme = 'default' }: AppProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [isDarkTheme, setIsDarkTheme] = useState(false);

  // Auto-detect dark mode
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    setIsDarkTheme(mediaQuery.matches);

    const listener = (e: MediaQueryListEvent) => setIsDarkTheme(e.matches);
    mediaQuery.addEventListener('change', listener);
    return () => mediaQuery.removeEventListener('change', listener);
  }, []);

  // Apply theme attributes
  useEffect(() => {
    if (containerRef.current) {
      containerRef.current.setAttribute('data-theme', theme);
      containerRef.current.setAttribute('data-dark-theme', isDarkTheme ? 'true' : 'false');
    }
  }, [theme, isDarkTheme]);

  return (
    <div ref={containerRef} className="your-app">
      {/* Your app content */}
    </div>
  );
}
```

### Step 3: Use CSS Variables (NO Hardcoded Colors)

In `src/styles/index.css`:
```css
/* ✅ CORRECT - Use theme variables */
.your-app {
  background-color: var(--theme-background);
  color: var(--theme-text);
  border: 1px solid var(--theme-border);
}

.your-app button {
  background-color: var(--theme-primary);
  color: var(--theme-primary-text);
}

.your-app button:hover {
  background-color: var(--theme-primary-hover);
}

/* ❌ WRONG - DO NOT hardcode colors */
.your-app {
  background-color: #ffffff;  /* NO! */
  color: #000000;             /* NO! */
}
```

### Available Theme Variables

```css
/* Layout */
--theme-background
--theme-surface
--theme-border

/* Text */
--theme-text
--theme-text-secondary
--theme-heading

/* Interactive */
--theme-primary
--theme-primary-hover
--theme-primary-text
--theme-secondary
--theme-accent

/* State */
--theme-success
--theme-error
--theme-warning
--theme-info

/* Shadows & Effects */
--theme-shadow
--theme-radius
```

See `@wolffm/themes/themes.css` for full list.

---

## Code Quality Standards

### Husky Pre-Commit Hook

**Auto-enforced on every commit**:
1. **ESLint auto-fix**: Automatically fixes linting issues (only blocks on unfixable errors)
2. **Prettier formatting**: Auto-formats all files
3. **Version bump**: Only if `src/` or `package.json` changed (patch increment)
4. **Auto-stage changes**: Fixed files are automatically staged

**To skip** (use sparingly):
```bash
git commit --no-verify -m "docs: update README"
```

**Note**: Hook now auto-fixes instead of blocking, making commits smoother.

### Prettier Config (`.prettierrc`)

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "printWidth": 100,
  "trailingComma": "es5"
}
```

### ESLint Config (`eslint.config.js`)

```javascript
import js from '@eslint/js';
import tseslint from 'typescript-eslint';
import react from 'eslint-plugin-react';

export default [
  js.configs.recommended,
  ...tseslint.configs.recommended,
  {
    files: ['**/*.{ts,tsx}'],
    plugins: { react },
    rules: {
      'no-console': 'warn',
      '@typescript-eslint/no-explicit-any': 'warn',
      'react/react-in-jsx-scope': 'off'
    }
  }
];
```

### TypeScript Config (`tsconfig.json`)

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "strict": true,
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true,
    "declarationMap": true,
    "outDir": "./dist"
  },
  "include": ["src"]
}
```

---

## Deployment Pipeline

### How It Works

1. **Developer commits** → Pre-commit hook runs (format, lint, version bump)
2. **Push to main** → GitHub Actions triggers (`.github/workflows/publish.yml`)
3. **Workflow builds package** → Compiles TypeScript, bundles with Vite
4. **Publishes to GitHub Packages** → Available as `@wolffm/your-app@1.0.1`
5. **Triggers parent** → Sends `repository_dispatch` to `hadoku_site`
6. **Parent updates** → Pulls new version, rebuilds, redeploys

### Workflow File (`.github/workflows/publish.yml`)

```yaml
name: Publish Package

on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'
          scope: '@wolffm'

      - run: pnpm install
      - run: pnpm build
      - run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger parent deployment
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HADOKU_SITE_TOKEN }}
          repository: wolffm/hadoku_site
          event-type: deploy-your-app
          client-payload: '{"version": "${{ github.ref_name }}"}'
```

**Note**: Replace `deploy-your-app` with your app name.

---

## Troubleshooting

### Workflow not triggering parent?

**Check**:
- `HADOKU_SITE_TOKEN` exists in repo secrets
- Token has `repo` + `workflow` scopes
- Repository name is correct in workflow

**Verify**:
```bash
curl -X POST https://api.github.com/repos/wolffm/hadoku_site/dispatches \
  -H "Authorization: token $HADOKU_SITE_TOKEN" \
  -d '{"event_type":"deploy-your-app"}'
# Should return HTTP 204
```

### Version not incrementing?

**Check**:
- `.husky/pre-commit` is executable: `chmod +x .husky/pre-commit`
- `prepare` script exists in `package.json`
- Node.js is in PATH

**Test**:
```bash
.husky/pre-commit
cat package.json | grep version
```

### Package not publishing?

**Check**:
- `publishConfig.registry` = `https://npm.pkg.github.com`
- Package name starts with `@wolffm/`
- `GITHUB_TOKEN` has `packages: write` permission

**Manual publish**:
```bash
pnpm build
pnpm publish
```

### Theme not working?

**Check**:
- `import '@wolffm/themes/themes.css'` in `entry.tsx`
- `data-theme` attribute set on container
- CSS uses `var(--theme-*)` variables (NO hardcoded colors)

**Debug**:
```javascript
// In browser console
const el = document.querySelector('.your-app');
console.log(el.getAttribute('data-theme'));
console.log(getComputedStyle(el).getPropertyValue('--theme-background'));
```

### Parent not loading app?

**Check**:
- `mount()` function exported from `entry.tsx`
- `external` config in `vite.config.ts` includes `react`, `react-dom`, `@wolffm/themes`
- Build output includes `index.js` and `style.css`

---

## Best Practices

### 1. Keep Bundle Small
- Use `peerDependencies` for shared libraries
- Mark external dependencies in Vite config
- Avoid large dependencies (prefer native APIs)

### 2. Follow Theme System
- ALWAYS import `@wolffm/themes/themes.css`
- NEVER hardcode colors (use CSS variables)
- Set `data-theme` and `data-dark-theme` attributes

### 3. Clean Unmount
```typescript
export function unmount(el: HTMLElement) {
  const root = (el as any).__root;
  if (root) {
    root.unmount();
    delete (el as any).__root;
  }
}
```

### 4. Type Safety
- Use TypeScript strict mode
- Define props interface
- Export types for parent to use

### 5. Error Handling
```typescript
export function mount(el: HTMLElement, props: AppProps = {}) {
  try {
    const root = createRoot(el);
    root.render(<App {...props} />);
    (el as any).__root = root;
  } catch (error) {
    console.error('Failed to mount app:', error);
    el.innerHTML = '<p>Failed to load application</p>';
  }
}
```

---

## Next Steps

1. Copy template to your new repo
2. Follow setup instructions above
3. Customize for your app
4. Push to main to test deployment
5. Verify parent integration

---

## Resources

- [Husky](https://typicode.github.io/husky/) - Git hooks
- [pnpm](https://pnpm.io/) - Package manager
- [Vite](https://vitejs.dev/) - Build tool
- [GitHub Actions](https://docs.github.com/en/actions) - CI/CD
- [GitHub Packages](https://docs.github.com/en/packages) - NPM registry

---

*Last Updated*: 2025-11-16
